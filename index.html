<!DOCTYPE html>
<html>
  <head>
    <title>&lt;geolocation&gt; Demo</title>
    <meta charset="utf8">
  </head>
  <body>
    Select your location: <geo-location id="location"><span slot="text">üó∫Ô∏è</span></geo-location>
    <p id="result" style="display: none"></p>
  </body>
  <script>
    const loc = document.getElementById("location");
    function show(msg) {
      const res = document.getElementById("result");
      res.textContent = msg;
      res.style.display = "block";
    }
    loc.addEventListener("location", e => {
      show(`Got location: ${e.coords.latitude}, ${e.coords.longitude}`);
    });
    loc.addEventListener("locationerror", e => {
      show(`Error: ${e.message}`);
    });
  </script>

  <template id="geolocation-template">
    <link rel="stylesheet" href="leaflet.css"/>
    <script src="leaflet.js"></script>
    <style>
      #pick {
        anchor-name: --pick;
      }
      #container {
        display: none;
      }
      #container.open {
        border: 1px solid black;
        border-radius: 4px;
        padding: 4px;
        display: block flex;
        width: 480px;
        height: 320px;
        position: fixed;
        position-anchor: --pick;
        position-area: block-start;
        position-try: flip-block;
      }
      #map {
        height: 100%;
        flex-grow: 1;
      }
      #controls {
        display: block flex;
        flex-direction: column;
        justify-content: end;
        margin: 4px;
        padding: 4px;
      }
      #controls button {
        border: 1px solid black;
        border-radius: 4px;
        width: 100%;
        margin: 4px;
        padding: 4px;
      }
      #cancel {
        background-color: white;
        color: black;
      }
      #ok[disabled] {
        background-color: lightgrey;
        color: black;
      }
      #ok {
        background-color: blue;
        color: white;
      }
    </style>
    <!-- Hacky DOM: this needs more than this -->
    <button id=pick><slot name="text">Select Location</slot></button>
    <div id=container>
      <div id=map></div>
      <div id=controls>
        <button id=cancel>Cancel</button>
        <button id=ok disabled>Ok</button>
      </div>
    </div>
  </template>
  <script>
    const defaultLocation = [-33.858888, 151.210113];
    const markerOptions = {
      alt: "selected location",
      draggable: true,
      autoPan: true,
    };
    class GeolocationEvent extends Event {
      constructor(options) {
        super("location", options);
        // TODO: It's not possible to construct GeolocationPosition.
        this.coords = options.coords;
        this.timestamp = options.timestamp;
      }
    }
    class GeolocationElement extends HTMLElement {
      constructor() {
        super();
        this._internals = this.attachInternals();
      }

      connectedCallback() {
        const shadow = this.attachShadow({ mode: "open" });
        const template = document.getElementById("geolocation-template");
        const copy = template.content.cloneNode(true);
        const pick = copy.getElementById("pick");
        pick.addEventListener("click", e => {
          this.toggle();
        });
        copy.getElementById("ok").addEventListener("click", e => this.pick(null, true));
        copy.getElementById("cancel").addEventListener("click", e => this.cancel());
        shadow.appendChild(copy);
      }

      toggle(to) {
        let c = this.shadowRoot.getElementById("container");
        if (typeof to === "undefined") {
          c.classList.toggle("open");
          this.makeMap();
        } else if (to) {
          c.classList.add("open");
          this.makeMap();
        } else {
          c.classList.remove("open");
        }
      }

      makeMap() {
        if (!this._map) {
          let m = this.shadowRoot.getElementById("map");
          this._map = L.map(m).setView(defaultLocation, 13);
          L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            doubleClickZoom: false,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          }).addTo(this._map);
          this._map.on("click", e => {
            this.pick(e.latlng, false);
          });
          this._map.on("dblclick", e => {
            this.pick(e.latlng, true);
          });

          markerOptions.icon = new L.Icon.Default({ imagePath: "images/" });
        }
      }

      cancel() {
        if (this._marker) {
          this._marker.remove();
        }
        this.toggle(false);
        this.dispatchEvent(new ErrorEvent("locationerror", { message: "cancelled" }));
      }

      pick(pos, dispatch) {
        if (pos) {
          if (this._marker) {
            this._marker.remove();
          }
          this._marker = L.marker(pos, markerOptions);
          this._marker.addTo(this._map);

          this.shadowRoot.getElementById("ok").disabled = false;
        } else {
          if (!this._marker) { return; }
          pos = this._marker.getLatLng();
        }
        if (dispatch) {
          this.toggle(false);
          this.dispatchEvent(new GeolocationEvent({
            coords: {
              latitude: pos.lat,
              longitude: pos.lng,
            },
            timestamp: Date.now(),
          }));
        }
      }

      get value() {
        const pos = this._marker?.getLatLng();
        if (pos) {
          return `${pos.lat},${pos.lng}`;
        }
        return "";
      }

      set value(v) {
        this.makeMap();
        let [lat, lng] = v.split(',');
        let pos = new L.LatLng(lat, lng);
        if (!this._marker) {
          this._marker = L.marker(pos, markerOptions);
          this._marker.addTo(this._map);
        } else {
          this._marker.setLatLng(pos);
        }
        this._map.flyTo(pos);
        this._value = v;
      }
    }
    customElements.define("geo-location", GeolocationElement);
  </script>
</html>
